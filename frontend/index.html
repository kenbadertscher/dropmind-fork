<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>DropMind</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">


<style>

/* ================= BASE ================= */


body {
  margin: 0;
  font-family: system-ui,-apple-system,BlinkMacSystemFont;
  background: #0f172a;
  color: #e5e7eb;
}

* {
  -webkit-tap-highlight-color: transparent;
}

html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}

html, body {
  overscroll-behavior: none;
}

.chat {
    width: 100%;
    max-width: 840px;
    margin: auto;

    display: flex;
    flex-direction: column;

    height: 100%;
    overflow: hidden;      /* gi√† messo, resta */
    overscroll-behavior: contain;
    background: #020617;

    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0,0,0,.5);

    padding-top: env(safe-area-inset-top);
    padding-bottom: 0;
}

/* ================= HEADER ================= */

header {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;

    background: rgba(2, 6, 23, 0.75);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(148,163,184,0.12);

}

.header-top,
.header-bottom{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px;
  flex-wrap:wrap;
}

header strong {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 0.3px;
}

.header-top{
  border-bottom:1px solid #1e293b;
}

#refreshBtn {
  font-size: 26px;
  line-height: 1;
}

#refreshBtn {
  cursor: pointer;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

#refreshBtn:focus,
#refreshBtn:focus-visible {
  outline: none;
  box-shadow: none;
}

/* Rimuove stato active iOS */
#refreshBtn:active {
  background: rgba(255,255,255,0.04) !important;
  transform: none !important;
}

#refreshBtn {
  -webkit-tap-highlight-color: transparent;
}

.header-right{
  display:flex;
  align-items:center;
  gap:8px;
  margin-left:auto;
}

header input,
header select{
  height: 38px;
  padding: 0 14px;

  background: rgba(255,255,255,0.04);
  color: #e5e7eb;

  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;

  font-size: 14px;

  backdrop-filter: blur(6px);
  transition: all .15s ease;
}

header select:hover,
header select:focus{
  border-color: rgba(59,130,246,0.5);
  background: rgba(59,130,246,0.08);
  outline: none;
}

#search{
  width:150px;
  border-radius:999px;
  padding:4px 10px;
}

#search:focus{
  outline:none;
  border-color:#2563eb;
}

/* SOLO DESKTOP */
@media (min-width: 769px) {

    .header-bottom {
        flex-wrap: nowrap;   /* niente andare a capo */
    }

    #search {
        margin-left: auto;   /* spinge tutto a destra */
    }

}

/* ================= HEADER BUTTONS ================= */

.header-top button {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;

  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  color: #e5e7eb;
  border-radius: 10px;

  backdrop-filter: blur(6px);

  cursor: pointer;
  font-size: 14px;
  transition: all 0.15s ease;
}

/* Refresh come header button anche se √® div */
#refreshBtn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;

  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  color: #e5e7eb;
  border-radius: 10px;

  backdrop-filter: blur(6px);
  transition: all 0.15s ease;

  cursor: pointer;
}

#refreshBtn:hover {
  background: rgba(59,130,246,0.15);
  border-color: rgba(59,130,246,0.4);
  transform: scale(1.05);
}

.header-top button:focus,
.header-top button:focus-visible {
  outline: none;
  box-shadow: none;
}

.header-top button:hover {
  background: rgba(59,130,246,0.15);
  border-color: rgba(59,130,246,0.4);
  transform: scale(1.05);
}

#favoriteClipboardBtn.favorite-active {
  background: rgba(59,130,246,0.25);
  border-color: rgba(59,130,246,0.6);
  color: #60a5fa;
}

#refreshBtn svg {
  width: 20px;
  height: 20px;
  stroke: currentColor;
  stroke-width: 2;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
}

#refreshBtn.spinning svg {
  animation: spin 0.6s linear;
}

/* Rimuove focus visivo iOS sul refresh */
#refreshBtn:focus,
#refreshBtn:focus-visible {
  outline: none !important;
  box-shadow: none !important;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

#mobileMenuBtn {
   display: none;
 }

#mobileMenuBtn {
  -webkit-tap-highlight-color: transparent;
}

/* ================= CHECKBOX STYLE ================= */

input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;

  width: 18px;
  height: 18px;

  position: relative;
  cursor: pointer;

  border: none;
  background: none;
  padding: 0;
  margin: 0;

  flex: 0 0 18px;
}

/* Quadrato reale */
input[type="checkbox"]::before {
  content: "";
  position: absolute;
  inset: 0;

  border: 1px solid #334155;
  border-radius: 5px;
  background: #0f172a;
  box-sizing: border-box;
}

/* Stato checked */
input[type="checkbox"]:checked::before {
  background: #2563eb;
  border-color: #2563eb;
}

/* Spunta */
input[type="checkbox"]:checked::after {
  content: "‚úì";
  position: absolute;
  inset: 0;

  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 13px;
  color: white;
}

.check-toggle{
  display:flex;
  align-items:center;
  gap:8px;
}

input[type="checkbox"]:checked {
  background: #2563eb;
  border-color: #2563eb;
}

.check-icon {
  width:18px;
  height:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:.7;
}

.check-icon svg {
  width:16px;
  height:16px;
  stroke: currentColor;
}

/* ================= GLOBAL CHECKBOX ALIGN ================= */

.global-toggle {
  display:flex;
  align-items: center;
  gap: 6px;
}

.filters-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* ================= MESSAGES ================= */

.messages{
  flex:1;
  min-height:0;
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  position: relative;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

.messages-wrapper {
  position: relative;
  flex: 1;
  overflow: hidden;
  isolation: isolate;
}

.messages {
  height: 100%;
  overflow-y: auto;
}

/* ================= SCROLL SHADOW ================= */

.messages-wrapper::before,
.messages-wrapper::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    height: 22px;
    pointer-events: none;
    z-index: 5;
}

.messages-wrapper::before {
    top: 0;
    background: linear-gradient(
        to bottom,
        rgba(2,6,23,0.85),
        rgba(2,6,23,0)
    );
}

.messages-wrapper::after {
    bottom: 0;
    background: linear-gradient(
        to top,
        rgba(2,6,23,0.85),
        rgba(2,6,23,0)
    );
}

.messages::-webkit-scrollbar{
  width:8px;
}
.messages::-webkit-scrollbar-thumb{
  background:#1e293b;
  border-radius:8px;
}
.messages::-webkit-scrollbar-thumb:hover{
  background:#334155;
}

/* ================= MESSAGE CARD ================= */

.message{
    position: relative;
    padding: 14px 90px 14px 14px;
    background: #1e293b;
    border-radius: 14px;
    border: 1px solid #334155;

    box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.02),
        0 4px 14px rgba(0,0,0,0.25);

    transition: background .15s ease, transform .12s ease;

    animation: messageFadeIn .28s cubic-bezier(.4,0,.2,1);

}

.message:hover{
  background:#223049;
  transform: translateY(-1px);
  transition: all .15s ease;
}

@keyframes messageFadeIn {
  from {
    opacity: 0;
    transform: translateY(3px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message.pinned{
  background:#1f2a44;
  border-left:4px solid #3b82f6;
}

.message.pinned:hover{
  background:#243049;
}

/* PIN anche per image e link */
.message.image.pinned,
.message.link.pinned {
  border-left: 4px solid #3b82f6;
}

.message.image.pinned {
  background: #1f2a44;
}

.message.link.pinned {
  background: linear-gradient(135deg, #1f2a44, #1c2b4a);
}

.message.file{
  background:#1e293b;
  border:1px dashed #334155;
}

.message.image {
    min-height: 260px;
    max-height: 260px;
    box-sizing: border-box;

    /* Layout */
    display: flex;
    align-items: center;
    justify-content: center;

    /* Spazio pulsanti */
    padding: 12px 90px 12px 12px;

    background: #1e293b;
    border: 1px solid #334155;
    position: relative;
    overflow: hidden;
}

.message.image:hover {
    background: #223049;
}

.image-wrapper{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  width:100%;
}

.image-wrapper .file-text{
  margin-top:12px;
  font-size:14px;
  opacity:.85;
  text-align:center;
}

.message.image > div:first-child {
    display: flex;
    align-items: center;
    justify-content: center;
}

.message.image img{
    max-width:100%;
    max-height:210px;   /* 260 - padding */
    object-fit:contain;
    border-radius:10px;
    display:block;
    margin:auto;
    transition: transform .25s ease, filter .25s ease;
    box-shadow: 0 8px 24px rgba(0,0,0,0.45);
}

.message.image.move-active img {
  box-shadow: none !important;
}

.message.image img {
    -webkit-touch-callout: none;
}

.message.image:hover img{
    transform: scale(1.01);
    filter: brightness(1.05);
}

.message.move-active .message-actions {
  display: none !important;
}

.file-card{
  display:flex;
  align-items:center;
  gap:10px;
}

.file-icon{
  font-size:18px;
  opacity:.7;
}

.file-text {
    margin-top: 8px;
    font-size: 14px;
    opacity: 0.85;
}

.file-name{
  flex:1;
  font-weight:500;
  color:#e5e7eb;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.file-download{
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
  background:#0f172a;
  border:1px solid #334155;
  color:#94a3b8;
  text-decoration:none;
  transition:all .15s ease;
}

.file-download:hover{
  background:#1e293b;
  border-color:#3b82f6;
  color:#60a5fa;
  transform:scale(1.05);
}

.message.location {
    background: linear-gradient(135deg, #1e293b, #1c2b4a);
    border: 1px solid #334155;
}

.message.location.pinned {
    border-left: 4px solid #3b82f6;
}

/* ================= LINK CARD ================= */

.message.link {
    background: linear-gradient(135deg, #1e293b, #1b2a4a);
    border: 1px solid #334155;
    cursor: pointer;
}

.link-card {
    display: flex;
    gap: 12px;
    align-items: center;
}

.link-icon {
    font-size: 20px;
    opacity: 0.8;
}

.link-info {
    display: flex;
    flex-direction: column;
}

.link-domain {
    font-weight: 600;
    color: #60a5fa;
}

.link-url {
    font-size: 12px;
    opacity: 0.7;
    word-break: break-all;
}

/* ================= TEXT EXPAND ================= */

/* compressed */
.message-text {
  display: -webkit-box;
  -webkit-line-clamp: 4; /* mostra 4 righe max */
  -webkit-box-orient: vertical;
  overflow: hidden;
  white-space: pre-line;
  word-break: break-word;
  overflow-wrap: anywhere;

}

.message-text {
  transition: all 0.25s ease;
}

/* expanded */
.message-text.expanded {
  -webkit-line-clamp: unset;
}

.expand-btn {
  margin-top: 8px;
  padding: 6px 12px;
  font-size: 13px;
  border-radius: 8px;
  border: 1px solid #334155;
  background: rgba(255,255,255,0.04);
  color: #94a3b8;
  cursor: pointer;
  transition: all 0.15s ease;
}

.expand-btn:hover {
  background: rgba(59,130,246,0.15);
  border-color: rgba(59,130,246,0.4);
  color: #60a5fa;
}

/* ================= MOVE UI ================= */

.move-select {
  margin-top: 12px;
  display: flex;
  gap: 10px;
  align-items: center;
}

.move-select select {
  padding: 8px 12px;
  border-radius: 12px;
  border: 1px solid #334155;
  background: #0f172a;
  color: #e5e7eb;
  font-size: 14px;
  min-width: 120px;
  max-width: 160px;
}

.move-select button {
  padding: 8px 14px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.05);
  color: #e5e7eb;
  cursor: pointer;
  transition: all 0.15s ease;
}

.move-select button:hover {
  background: rgba(59,130,246,0.15);
  border-color: rgba(59,130,246,0.4);
  color: #60a5fa;
}

.move-select .confirm-move {
  background: linear-gradient(135deg, #4f8cff, #2563eb);
  border: none;
  color: white;
}

.move-select .confirm-move:hover {
  transform: translateY(-1px);
}

/* ================= ACTIONS ================= */

.message-actions{
  position:absolute;
  top:50%;
  right:10px;
  transform: translateY(-50%) translateX(8px);
  display:flex;
  gap:6px;
  padding-left:10px;
  border-left:1px solid #334155;
  opacity:0;
  pointer-events: none;
  transition: opacity .25s ease, transform .25s cubic-bezier(.4,0,.2,1);
}

.message.show-actions .message-actions{
  opacity: 1;
  transform: translateY(-50%) translateX(0);
  pointer-events: auto;
}

.message.actions-vertical .message-actions{
  flex-direction: column;
}

.message.actions-horizontal .message-actions{
  flex-direction: row;
}

@media (hover: hover) and (pointer: fine) {

  .message:not(.show-actions):hover .message-actions{
    opacity:1;
    transform: translateY(-50%) translateX(0);
    pointer-events: auto;
  }

}

.message-actions button {
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;

    background: rgba(8, 15, 28, 0.85);    /* sfondo pi√π scuro */
    backdrop-filter: blur(6px);           /* blur leggero */
    -webkit-backdrop-filter: blur(6px);

    border: 1px solid rgba(255,255,255,0.18);
    color: #e5e7eb;
    border-radius: 10px;

    box-shadow:
    0 6px 18px rgba(0,0,0,0.45),
    inset 0 0 0 1px rgba(255,255,255,0.05);

    cursor: pointer;
    font-size: 15px;
    transition: all 0.15s ease;
}

.message-actions button:hover {
  background: rgba(59,130,246,0.15);
  border-color: rgba(59,130,246,0.4);
  transform: scale(1.05);
}

.img-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    backdrop-filter:blur(6px);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
    cursor:zoom-out;
}

.img-overlay img{
    max-width:90vw;
    max-height:90vh;
    border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,0.6);
    animation:zoomIn .2s ease;
}

@keyframes zoomIn{
    from{transform:scale(.9);opacity:0;}
    to{transform:scale(1);opacity:1;}
}

/* ================= INPUT ================= */

.input {
    display: flex;
    align-items: center;
    gap: 10px;

    padding: 12px;
    border-top: 1px solid rgba(148,163,184,0.15);

    flex-shrink: 0;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
}

.input input[type="text"]{
  flex:1;
  height:44px;
  padding:0 18px;
  border-radius:999px;
  border:1px solid #334155;
  background:#0f172a;
  color:#e5e7eb;
}

.input button{
  background: linear-gradient(135deg, #4f8cff, #2563eb);
  border: none;
  height: 44px;
  padding: 0 20px;
  min-width: 78px;
  border-radius: 999px;
  color: white;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;

  box-shadow: 
    inset 0 1px 0 rgba(255,255,255,0.25),
    0 4px 14px rgba(37,99,235,0.35);

  transition: all 0.18s ease;
}

.input button:hover{
  transform: translateY(-1px);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.3),
    0 6px 18px rgba(37,99,235,0.45);
}

.input button:active{
  transform: translateY(0);
  box-shadow: 0 4px 14px rgba(37,99,235,0.35);
}

.input button:disabled{
  opacity: 0.45;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}

#filePreview {
  max-width: 120px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.input {
  flex-wrap: nowrap;
}

.input input[type="text"] {
  min-width: 0;
}

mark{
  background: #facc15;
  color: #000;
  padding: 0 3px;
  border-radius: 4px;
  font-weight: 600;
}

.file-btn{
  width:44px;
  height:44px;
  border-radius:50%;

  background:#0f172a;
  border:1px solid #334155;

  display:flex;
  align-items:center;
  justify-content:center;

  cursor:pointer;
  transition: all .15s ease;
}

.file-btn:hover{
  background:#1e293b;
  border-color:#3b82f6;
  transform: scale(1.05);
}

.plus-icon{
  width:20px;
  height:20px;
  color:#e5e7eb;
}

.mobile-action {
  width: 100%;
  padding: 14px 18px;
  border-radius: 14px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.08);
  color: #e6edf7;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: center;
  transition: background 0.2s ease, transform 0.15s ease;
}

.mobile-action:active {
  background: rgba(255,255,255,0.12);
  transform: scale(0.98);
}

.mobile-action:hover {
    background: #223049;
}

.mobile-action svg {
  transform: translateY(-1px);
}

/* PIN ATTIVO */
.message-actions button.pin-active {
    background: rgba(59,130,246,0.25) !important;
    border-color: rgba(59,130,246,0.6) !important;
    color: #60a5fa !important;
}

/* Offline Banner */
.offline-banner {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #ffcc00;
  color: #000;
  text-align: center;
  padding: 6px;
  font-size: 13px;
  font-weight: 500;
  display: none;
  z-index: 9999;
}

@media(max-width:1200px){

  .chat{
    width:100vw;
    max-width:none;
    margin:0;
    border-radius:0;
    box-shadow:none;
  }

}

/* ================= List in iOS ================= */

select {
  background-color: #0b1220;
  color: #e5e7eb;
  border: 1px solid #1e293b;
  border-radius: 12px;
  padding: 10px 12px;
  font-size: 14px;

  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23cbd5e1' viewBox='0 0 20 20'%3E%3Cpath d='M5.25 7.5l4.75 4.75L14.75 7.5' stroke='%23cbd5e1' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 16px;
  padding-right: 32px;
}

/* ===============================
   Mobile layout
================================ */

@media (max-width: 767px) {

.chat {
    height: 100%;
}

#mobileMenuBtn {
    display: flex;
    width: 40px;
    height: 40px;
    font-size: 18px;
    border-radius: 10px;
    align-items: center;
    justify-content: center;
}

/* ===== Mobile header ===== */

/* HEADER TOP Mobile */

.header-top {
    display: flex;
    align-items: center;
    gap: 12px;
}

.header-top select {
    flex: 1;
    min-width: 0;
}

/* REFRESH before menu */
#refreshBtn {
    order: 2;
    width: 40px;
    height: 40px;
    font-size: 26px;
    line-height: 1;
    border-radius: 10px;
}

#mobileMenuBtn {
    order: 3;
    margin-left: 0;
}

/* Nascondiamo azioni desktop */
#createClipboardBtn,
#renameClipboard,
#deleteClipboard,
#favoriteClipboardBtn {
    display: none !important;
}

.header-right select {
    display: none !important;
}

/* Titolo pi√π compatto */
.header-top strong {
    font-size: 16px;
    white-space: nowrap;
}

/* Clipboard centrale */
#clipboardSelect {
    flex: 1 1 auto;
    min-width: 0;
    max-width: 55%;
    font-size: 16px;
}

/* Bottone menu sempre visibile */
#mobileMenuBtn {
    display: flex;
}

/* Header bottom visibile */

.header-bottom {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-bottom #search {
  flex: 1;
  min-width: 0;
}

.header-bottom .global-toggle {
  flex-shrink: 0;
}

.filters-row {
  display: none;
}

/* Search prende spazio */
#search {
    flex: 1;
    font-size: 16px;
}

.messages {
    flex: 1;
    overflow-y: auto;
}

    /* CARD NORMALI */
    .message {
        padding: 14px 70px 14px 14px;
        margin: 0 12px 14px 12px;
        border-radius: 18px;
        overflow: visible;
    }

    /* CARD IMAGE */
    .message.image {
    min-height: 260px;
    max-height: 330px;

    display: flex;
    align-items: center;
    justify-content: center;

    padding: 16px 70px 16px 16px;
    box-sizing: border-box;
}

.card-actions button svg {
  display: block;
  width: 18px;
  height: 18px;
}

    .message.image img {
    max-height: 220px;
    width: auto;
    max-width: 100%;
    object-fit: contain;

    margin: 16px 0;
}

.image-wrapper {
      max-height: 240px;
      overflow: visible;
      display: flex;
      flex-direction: column;
      align-items: center;
  }

  .image-wrapper img {
      max-height: 200px;
      width: auto;
      object-fit: contain;
  }

}

    /* BUTTONS LATERAL */
    .message-actions {
        right: 8px;
        transform: translateY(-50%) translateX(4px);
    }

    .message-actions button {
        width: 44px;
        height: 44px;
        border-radius: 14px;
    }


    /* INPUT BAR */

.input {
    padding: 12px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
    flex-shrink: 0;
}

    .input input[type="text"] {
        font-size: 16px;
    }

    .input button {
        height: 44px;
        min-width: 90px;
    }
}

/* Dark select */
.mobile-menu select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;

    width: 100%;
    padding: 10px 14px;

    border-radius: 12px;
    border: 1px solid #334155;

    background-color: #0f172a;
    color: #e5e7eb;

    font-size: 14px;
}

.mobile-menu select {
    background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23cbd5e1'>\
<path fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z' clip-rule='evenodd'/>\
</svg>");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 36px;
}

.mobile-menu select option {
    background-color: #0b1220;
    color: #e5e7eb;
}

.mobile-menu input[type="checkbox"] {
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.05);
  cursor: pointer;
  position: relative;
}

.mobile-menu input[type="checkbox"]:checked {
  background: #4e7cff;
  border-color: #4e7cff;
}

.mobile-menu input[type="checkbox"]:checked::after {
  content: "";
  position: absolute;
  top: 3px;
  left: 5px;
  width: 4px;
  height: 8px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.mobile-menu h3 {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 1px;
  opacity: 0.6;
  margin-bottom: 12px;
}

.mobile-menu select {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  color: #e6edf7;
  font-size: 15px;
}

.mobile-filter {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 15px;
  color: #e6edf7;
}

.mobile-filter input[type="checkbox"] {
  flex-shrink: 0;
}

.mobile-filter .filter-icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8;
}

.mobile-filter .filter-icon svg {
  width: 18px;
  height: 18px;
}

.active-filters {
  padding: 8px 14px;
  font-size: 13px;
  background: rgba(59,130,246,0.12);
  border-bottom: 1px solid rgba(59,130,246,0.25);
  color: #93c5fd;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.active-filters span {
  background: rgba(59,130,246,0.25);
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
}

/* ============================
   MOBILE BOTTOM SHEET
============================ */

.mobile-menu {
    position: fixed;
    inset: 0;    
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(6px);

    display: flex;
    align-items: flex-end;

    opacity: 0;
    pointer-events: none;
    transition: opacity .38s cubic-bezier(.4,0,.2,1);

    z-index: 1000;
}

.mobile-menu.open {
    opacity: 1;
    pointer-events: auto;
}

/* Bottom sheet */
.mobile-menu-content {
    background: #0b1220;
    width: 100%;
    border-radius: 20px 20px 0 0;
    padding: 24px 20px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.6);
}

.mobile-menu-content {
    transform: translateY(100%);
    transition: transform .38s cubic-bezier(.4,0,.2,1);
}

.mobile-menu.open .mobile-menu-content {
    transform: translateY(0);
}

</style>

<link rel="icon" type="image/x-icon" href="favicon-rounded.ico">

</head>

<body>

<div id="offline-banner" class="offline-banner">
  ‚ö† You are offline
</div>

<div class="chat">

<header>
  <div class="header-top">
    <strong>DropMind</strong>

    <select id="clipboardSelect" onchange="load()"></select>
    <button id="createClipboardBtn"></button>
<button id="renameClipboard"></button>
<button id="deleteClipboard"></button>
<button id="favoriteClipboardBtn"></button>
    <button id="mobileMenuBtn">‚ò∞</button>

    <div class="header-right">

    <div id="refreshBtn" role="button" title="Refresh messages">
  <svg class="refresh-icon" viewBox="0 0 24 24">
    <path d="M21 12a9 9 0 1 1-3-6.7"/>
    <polyline points="21 3 21 9 15 9"/>
  </svg>
</div>

      <select id="order">
        <option value="recent">Most recent</option>
        <option value="oldest">Older first</option>
        <option value="activity">Recent activity</option>
      </select>
    </div>
  </div>

  <div class="header-bottom">
    <span>
      <div class="filters-row">

  <div class="check-toggle">
    <input type="checkbox" id="filterPinned">
    <span class="check-icon check-pin"></span>
  </div>

  <div class="check-toggle">
    <input type="checkbox" id="filterFiles">
    <span class="check-icon check-file"></span>
  </div>

  <div class="check-toggle">
    <input type="checkbox" id="filterText">
    <span class="check-icon check-text"></span>
  </div>

</div>
    </span>

    <input type="search" id="search" placeholder="Search...">

<label>
  <div class="global-toggle">
    <input type="checkbox" id="searchGlobal">
    <span>global</span>
  </div>
</label>

  </div>
</header>

  <div id="mobileMenu" class="mobile-menu">
  <div class="mobile-menu-content">

    <h3 style="margin-top:0;">Menu</h3>

<button id="closeMobileMenuBtn" 
        style="
        position:absolute;
        top:16px;
        right:16px;
        background:none;
        border:none;
        color:#e5e7eb;
        font-size:20px;
        cursor:pointer;">
‚úï
</button>

    <!-- Ordine -->
    <label style="display:block; margin-top:16px; font-size:14px; opacity:.7;">
      Order
    </label>

    <select id="order-mobile" style="width:100%; margin-top:6px;">
      <option value="recent">Most recent</option>
      <option value="oldest">Older first</option>
      <option value="activity">Recent activity</option>
    </select>

<!-- Clipboard Management -->
<div style="margin-top:24px; display:flex; flex-direction:column; gap:12px;">

<button id="mobileCreateClipboard" class="mobile-action"></button>
<button id="mobileRenameClipboard" class="mobile-action"></button>
<button id="mobileDeleteClipboard" class="mobile-action"></button>
<button id="mobileFavoriteClipboard" class="mobile-action"></button>

</div>

    <!-- Filters -->
<label style="display:block; margin-top:24px; font-size:14px; opacity:.7;">
    Filters
</label>

<div style="margin-top:24px; display:flex; flex-direction:column; gap:14px;">

  <label class="mobile-filter">
    <input type="checkbox" id="filterPinnedMobile">
    <span class="filter-icon filter-pin"></span>
    <span>Only pinned</span>
  </label>

  <label class="mobile-filter">
    <input type="checkbox" id="filterFilesMobile">
    <span class="filter-icon filter-file"></span>
    <span>Only file</span>
  </label>

  <label class="mobile-filter">
    <input type="checkbox" id="filterTextMobile">
    <span class="filter-icon filter-text"></span>
    <span>Only text</span>
  </label>

</div>

  </div>
</div>

<div class="messages-wrapper">
  <div id="activeFiltersBar" class="active-filters" style="display:none;"></div>
  <div id="messages" class="messages"></div>
</div>

<div class="input">
  <label class="file-btn">
  <svg viewBox="0 0 24 24" class="plus-icon">
    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <input type="file" id="file" hidden>
</label>

  <div id="filePreview" style="display:none; font-size:12px; opacity:.7;"></div>

  <input type="text" id="text" placeholder="What's on your mind?">

  <button id="sendBtn" onclick="send()">Send</button>
</div>

<div id="imgOverlay" class="img-overlay" style="display:none;">
    <img id="imgOverlayContent">
</div>

<script src="config.js"></script>
<script>

const API="/api";

const API_TOKEN = window.DM_CONFIG?.API_TOKEN || "";

const ICONS = {

  pin: `
  <svg viewBox="0 0 24 24" width="18" height="18"
       stroke="currentColor" fill="none"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="6" r="3"></circle>
    <path d="M12 9v9"></path>
    <path d="M9 18h6"></path>
  </svg>`,

  edit: `
  <svg viewBox="0 0 24 24" width="18" height="18"
       stroke="currentColor" fill="none"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M3 21l3-1 11-11-2-2L4 18l-1 3z"></path>
    <path d="M14 4l2 2"></path>
  </svg>`,

  delete: `
  <svg viewBox="0 0 24 24" width="18" height="18"
       stroke="currentColor" fill="none"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M3 6h18"></path>
    <path d="M8 6V4h8v2"></path>
    <path d="M6 6l1 14h10l1-14"></path>
  </svg>`,

  copy: `
  <svg viewBox="0 0 24 24" width="18" height="18"
       stroke="currentColor" fill="none"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="9" y="9" width="10" height="10" rx="2"></rect>
    <rect x="5" y="5" width="10" height="10" rx="2"></rect>
  </svg>`,

  move: `
  <svg viewBox="0 0 24 24" width="18" height="18"
       stroke="currentColor" fill="none"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M5 12h14"></path>
    <path d="M15 8l4 4-4 4"></path>
    <path d="M9 8l-4 4 4 4"></path>
  </svg>`,

plus: `
<svg viewBox="0 0 24 24" width="18" height="18"
 stroke="currentColor" fill="none"
 stroke-width="2" stroke-linecap="round">
 <path d="M12 5v14M5 12h14"/>
</svg>`,

star: `
<svg viewBox="0 0 24 24" width="18" height="18"
 stroke="currentColor" fill="none"
 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
 <polygon points="12 2 15 9 22 9 17 14 19 21 12 17 5 21 7 14 2 9 9 9"/>
</svg>`,

link: `
<svg viewBox="0 0 24 24" width="20" height="20"
 stroke="currentColor" fill="none"
 stroke-width="2" stroke-linecap="round">
 <path d="M10 13a5 5 0 0 1 0-7l2-2a5 5 0 0 1 7 7l-2 2"/>
 <path d="M14 11a5 5 0 0 1 0 7l-2 2a5 5 0 0 1-7-7l2-2"/>
</svg>`,

  map: `
  <svg viewBox="0 0 24 24" width="18" height="18"
       stroke="currentColor" fill="none"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M3 6l6-2 6 2 6-2v14l-6 2-6-2-6 2z"></path>
    <path d="M9 4v14"></path>
    <path d="M15 6v14"></path>
  </svg>`,

compass: `
<svg viewBox="0 0 24 24" width="20" height="20"
 stroke="currentColor" fill="none"
 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <circle cx="12" cy="12" r="9"></circle>
  <polygon points="14 10 10 14 12 12 14 10"></polygon>
</svg>`,

file: `
<svg viewBox="0 0 24 24" width="18" height="18"
 stroke="currentColor" fill="none"
 stroke-width="2" stroke-linecap="round">
 <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
 <polyline points="14 2 14 8 20 8"/>
</svg>`,

download: `
<svg viewBox="0 0 24 24" width="18" height="18"
     stroke="currentColor" fill="none"
     stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <path d="M12 3v12"></path>
  <path d="M8 11l4 4 4-4"></path>
  <path d="M5 21h14"></path>
</svg>`
};

document.getElementById("createClipboardBtn").innerHTML = `
<svg viewBox="0 0 24 24" width="18" height="18"
 stroke="currentColor" fill="none"
 stroke-width="2" stroke-linecap="round">
 <path d="M12 5v14M5 12h14"/>
</svg>`;

document.getElementById("renameClipboard").innerHTML = ICONS.edit;
document.getElementById("deleteClipboard").innerHTML = ICONS.delete;

document.getElementById("favoriteClipboardBtn").innerHTML = `
<svg viewBox="0 0 24 24" width="18" height="18"
 stroke="currentColor" fill="none"
 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
 <polygon points="12 2 15 9 22 9 17 14 19 21 12 17 5 21 7 14 2 9 9 9"/>
</svg>`;

document.querySelector(".check-pin").innerHTML = ICONS.pin;
document.querySelector(".check-file").innerHTML = ICONS.file;
document.querySelector(".check-text").innerHTML = ICONS.edit;

// === MOBILE MENU ICONS ===

document.getElementById("mobileCreateClipboard").innerHTML =
ICONS.plus + " New clipboard";

document.getElementById("mobileRenameClipboard").innerHTML =
ICONS.edit + " Rename";

document.getElementById("mobileDeleteClipboard").innerHTML =
ICONS.delete + " Delete";

document.getElementById("mobileFavoriteClipboard").innerHTML =
ICONS.star + " Starred";

document.querySelector(".filter-pin").innerHTML = ICONS.pin;
document.querySelector(".filter-file").innerHTML = ICONS.file;
document.querySelector(".filter-text").innerHTML = ICONS.edit;

function formatFileSize(bytes) {
  if (!bytes && bytes !== 0) return "";

  const kb = bytes / 1024;
  const mb = kb / 1024;

  if (mb >= 1) {
    return mb.toFixed(2) + " MB";
  } else {
    return kb.toFixed(1) + " KB";
  }
}

async function apiFetch(url, options = {}) {

  options.headers = {
    ...(options.headers || {}),
    "Authorization": `Bearer ${API_TOKEN}`
  };

  return fetch(url, options);
}

let CLIPBOARDS=[];

/* =========================
   LOAD CLIPBOARDS
========================= */
async function loadClipboards(forceSelectId = null){
  const res = await apiFetch(`${API}/clipboards`);
  if(!res.ok) return;

  CLIPBOARDS = await res.json();

const favoriteId = localStorage.getItem("dm_favorite_clipboard");

CLIPBOARDS.sort((a, b) => {

  // 1Ô∏è‚É£ Starred first
  if (a.id == favoriteId) return -1;
  if (b.id == favoriteId) return 1;

  // 2Ô∏è‚É£ Or alphabetic order
  return a.name.localeCompare(b.name, "it", { sensitivity: "base" });

});

  const select = document.getElementById("clipboardSelect");
  select.innerHTML = "";

  CLIPBOARDS.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    select.appendChild(opt);
  });

// Keep previous selection if possible
const currentValue = select.value;

if (forceSelectId) {
  select.value = forceSelectId;
} else if (currentValue && CLIPBOARDS.some(c => c.id == currentValue)) {
  select.value = currentValue;
} else if (CLIPBOARDS.length > 0) {
  select.value = CLIPBOARDS[0].id;
}
const desktopFavoriteBtn = document.getElementById("favoriteClipboardBtn");

if (desktopFavoriteBtn) {
  desktopFavoriteBtn.classList.toggle(
    "favorite-active",
    select.value == favoriteId
  );
}

}

async function createClipboard(){
  const name = prompt("New clipboard name:");
  if(!name) return;

  const res = await apiFetch(`${API}/clipboards`,{
    method:"POST",
    body:new URLSearchParams({ name })
  });

  if(!res.ok) return;

  const newClipboard = await res.json();

  await loadClipboards();

  const created = CLIPBOARDS.find(c => c.name === newClipboard.name);

  if (created) {
    const select = document.getElementById("clipboardSelect");
    select.value = created.id;
  }

  await load();
}

async function handleRenameClipboard() {

  const select = document.getElementById("clipboardSelect");
  const id = select.value;

  const current = CLIPBOARDS.find(c => c.id == id);
  if (!current) return;

  const newName = prompt("New name:", current.name);
  if (!newName || newName.trim() === "") return;

  await apiFetch(`${API}/clipboards/${id}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({
      name: newName.trim()
    })
  });

  await loadClipboards(id);
  await load();
}

document.getElementById("renameClipboard").onclick = handleRenameClipboard;

async function handleDeleteClipboard() {

  const select = document.getElementById("clipboardSelect");
  const id = select.value;

  const current = CLIPBOARDS.find(c => c.id == id);
  if (!current) return;

  if (current.name === "main") {
    alert("You cannot delete the main clipboard");
    return;
  }

  if (!confirm(`Delete "${current.name}"?`)) return;

  await apiFetch(`${API}/clipboards/${id}`, {
    method: "DELETE"
  });

  await loadClipboards();

  // Torna a main
  const mainClipboard = CLIPBOARDS.find(c => c.name === "main");
  if (mainClipboard) {
    select.value = mainClipboard.id;
  }

  load();
}

document.getElementById("deleteClipboard").onclick = handleDeleteClipboard;
document.getElementById("createClipboardBtn").onclick = createClipboard;

/* ===========================
   MOBILE MENU CLIPBOARD ACTIONS
=========================== */

  const mobileCreate = document.getElementById("mobileCreateClipboard");
  const mobileRename = document.getElementById("mobileRenameClipboard");
  const mobileDelete = document.getElementById("mobileDeleteClipboard");
  const mobileFavorite = document.getElementById("mobileFavoriteClipboard");

const desktopFavorite = document.getElementById("favoriteClipboardBtn");

if (desktopFavorite) {
  desktopFavorite.onclick = () => {

    const id = document.getElementById("clipboardSelect").value;

    localStorage.setItem("dm_favorite_clipboard", id);

    loadClipboards();
    load();
  };
}

if (mobileFavorite) {
  mobileFavorite.onclick = () => {

    const id = document.getElementById("clipboardSelect").value;

    localStorage.setItem("dm_favorite_clipboard", id);

    document.getElementById("mobileMenu").classList.remove("open");

    loadClipboards();
    load();
   };
}
  
  if (mobileCreate) {
    mobileCreate.onclick = () => {
      document.getElementById("mobileMenu").classList.remove("open");
      createClipboard();
    };
  }

  if (mobileRename) {
  mobileRename.onclick = async () => {
    await handleRenameClipboard();
    document.getElementById("mobileMenu").classList.remove("open");
  };
}

  if (mobileDelete) {
    mobileDelete.onclick = () => {
      document.getElementById("mobileMenu").classList.remove("open");
      handleDeleteClipboard();
    };
  }

/* =========================
   LOAD MESSAGES
========================= */
function highlight(text, search){
  if(!search) return text;

  const escaped = search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${escaped})`, "gi");

  return text.replace(regex, "<mark>$1</mark>");
}

function isMapUrl(url) {
  return url.includes("maps.apple.com") ||
         url.includes("maps.app.goo.gl") ||
         url.includes("google.com/maps");
}

function parseAppleMaps(url) {
  try {
    const u = new URL(url);
    const name = u.searchParams.get("name");
    const ll = u.searchParams.get("ll");

    return {
      name: name ? decodeURIComponent(name) : "Posizione",
      coords: ll || null
    };
  } catch {
    return null;
  }
}

async function load(){

  const clipboardId = document.getElementById("clipboardSelect").value;

  const favoriteId = localStorage.getItem("dm_favorite_clipboard");
const desktopFavoriteBtn = document.getElementById("favoriteClipboardBtn");

if (!navigator.onLine) {
  console.log("Offline: skip load");
  return;
}

if (desktopFavoriteBtn) {
  desktopFavoriteBtn.classList.toggle(
    "favorite-active",
    clipboardId == favoriteId
  );
}

  const order=document.getElementById("order").value;
  const isGlobal = document.getElementById("searchGlobal").checked;

let url = `${API}/messages?order=${order}`;

if(!isGlobal){
  url += `&clipboard_id=${clipboardId}`;
}

  const res=await apiFetch(url);
  if(!res.ok) return;

  const messages=await res.json();
  let filtered = messages;

// filtro pinned
if(document.getElementById("filterPinned").checked){
  filtered = filtered.filter(m => m.pinned === 1);
}

// filtro file
if(document.getElementById("filterFiles").checked){
  filtered = filtered.filter(m => m.filename);
}

// filtro text
if(document.getElementById("filterText").checked){
  filtered = filtered.filter(m => !m.filename);
}

// ricerca
const searchValue = document.getElementById("search").value.trim().toLowerCase();
if(searchValue){
  filtered = filtered.filter(m => 
    (m.text && m.text.toLowerCase().includes(searchValue)) ||
    (m.filename && m.filename.toLowerCase().includes(searchValue))
  );
}

const activeFiltersBar = document.getElementById("activeFiltersBar");

let activeLabels = [];

if(document.getElementById("filterPinned").checked){
  activeLabels.push("Pinned only");
}

if(document.getElementById("filterFiles").checked){
  activeLabels.push("Files only");
}

if(document.getElementById("filterText").checked){
  activeLabels.push("Text only");
}

if(activeLabels.length > 0){
  activeFiltersBar.style.display = "flex";
  activeFiltersBar.innerHTML =
    "<strong>Active filters:</strong> " +
    activeLabels.map(f => `<span>${f}</span>`).join("");
} else {
  activeFiltersBar.style.display = "none";
}

  const container=document.getElementById("messages");
  container.innerHTML="";

  filtered.forEach(m=>{
    const div = document.createElement("div");
div.className = "message";
div.setAttribute("data-id", m.id);
if(m.pinned) div.classList.add("pinned");

if (m.filename && m.filename.match(/\.(jpg|jpeg|png|gif)$/i)) {
  div.classList.add("image");
  div.classList.add("actions-vertical");
} 

    const content=document.createElement("div");

    if(m.filename){
      if(m.filename.match(/\.(jpg|jpeg|png|gif)$/i)){
  const displayName = m.original_filename || m.filename;

content.innerHTML = `
  <div class="image-wrapper">
    <img src="${API}/files/${m.filename}?token=${API_TOKEN}&t=${Date.now()}">
    ${m.text ? `<div class="file-text">${m.text}</div>` : ""}
  </div>
`;

setTimeout(() => {
  const img = content.querySelector("img");
  if (!img) return;

  img.addEventListener("click", () => {
    const overlay = document.getElementById("imgOverlay");
    const overlayImg = document.getElementById("imgOverlayContent");

    overlayImg.src = img.src;
    overlay.style.display = "flex";
  });
}, 0);
      }else{
    const displayName = m.original_filename || m.filename;

const fileNameDisplay = searchValue
  ? highlight(displayName, searchValue)
  : displayName;

const sizeText = formatFileSize(m.file_size);

content.innerHTML=`
  <div class="file-card">
    <span class="file-icon">
<svg viewBox="0 0 24 24" width="18" height="18"
 stroke="currentColor" fill="none"
 stroke-width="2" stroke-linecap="round">
 <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
 <polyline points="14 2 14 8 20 8"/>
</svg>
</span>
    <span class="file-name">
      ${m.original_filename || m.filename}
      ${sizeText ? `<span style="opacity:.6; font-size:12px; margin-left:6px;">(${sizeText})</span>` : ""}
    </span>
  </div>
  ${m.text ? `<div class="file-text">${m.text}</div>` : ""}
`;
      }

}else{

  const text = m.text || "";
  const urlRegex = /^https?:\/\/[^\s]+$/i;

  const parts = text.split(/\n?---\n?/);
  let urlPart = parts[0].trim();

// Estrai eventuale URL dentro testo misto
const urlMatch = urlPart.match(/https?:\/\/[^\s]+/);
if (urlMatch) {
  urlPart = urlMatch[0];
}
  const descriptionPart = parts[1] ? parts[1].trim() : "";

    if (isMapUrl(urlPart)) {
    div.classList.add("location");

let locationName = "Posizione salvata";
let coords = "";

if (urlPart.includes("maps.apple.com")) {
  try {
    const u = new URL(urlPart);
    locationName = u.searchParams.get("name") 
      ? decodeURIComponent(u.searchParams.get("name")) 
      : locationName;

    coords = u.searchParams.get("ll") ||
         u.searchParams.get("coordinate") ||
         "";
  } catch {}
}

content.innerHTML = `
  <div class="link-card">
    <div class="link-icon">${ICONS.map}</div>
    <div class="link-info">
      <div class="link-domain">${locationName}</div>
      ${coords ? `<div class="link-url">${coords}</div>` : ""}
      ${descriptionPart ? `<div class="file-text">${descriptionPart}</div>` : ""}
    </div>
  </div>
`;

} else if (urlRegex.test(urlPart)) {

    div.classList.add("link");

    content.innerHTML = `
      <div class="link-card">
        <div class="link-icon">${ICONS.link}</div>
        <div class="link-info">
          <div class="link-domain">${new URL(urlPart).hostname}</div>
          <div class="link-url">${urlPart}</div>
          ${descriptionPart ? `<div class="file-text">${descriptionPart}</div>` : ""}
        </div>
      </div>
    `;

  } else {

    const textElem = document.createElement("div");
    textElem.classList.add("message-text");

    if (searchValue) {
      textElem.innerHTML = highlight(text, searchValue);
    } else {
      textElem.textContent = text;
    }

    content.appendChild(textElem);

    if (text.length > 220) {

      const expandBtn = document.createElement("button");
      expandBtn.classList.add("expand-btn");
      expandBtn.textContent = "Show more";

      expandBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        textElem.classList.toggle("expanded");
        expandBtn.textContent =
          textElem.classList.contains("expanded")
            ? "Show less"
            : "Show more";
      });

      content.appendChild(expandBtn);
    }
  }
}

    div.appendChild(content);

// Desktop doppio click sulla card
let clickTimer = null;

div.addEventListener("click", (e) => {

  if (div.querySelector("textarea")) return;
  if (div.classList.contains("move-active")) return;

  if (clickTimer) {
    clearTimeout(clickTimer);
    clickTimer = null;
    enterEditMode(m, content);
  } else {
    clickTimer = setTimeout(() => {
      clickTimer = null;

// Apri link SOLO su desktop (mouse)
// Apri link SOLO su desktop (mouse)
if (
    (div.classList.contains("link") || div.classList.contains("location")) &&
    window.matchMedia("(hover: hover) and (pointer: fine)").matches
) {
    const url = m.text.match(/https?:\/\/[^\s]+/)?.[0];
    if (url) window.open(url, "_blank");
}
    }, 250); // soglia doppio click
  }

});

// Long press mobile
let pressTimer;
let startX = 0;
let startY = 0;
let isScrolling = false;

content.addEventListener("touchstart", (e) => {

  isScrolling = false;

  startX = e.touches[0].clientX;
  startY = e.touches[0].clientY;

  pressTimer = setTimeout(() => {
    if (!isScrolling) {
      enterEditMode(m, content);
    }
  }, 600); // leggermente pi√π lungo = pi√π sicuro
});

content.addEventListener("touchmove", (e) => {

  const moveX = e.touches[0].clientX;
  const moveY = e.touches[0].clientY;

  const diffX = Math.abs(moveX - startX);
  const diffY = Math.abs(moveY - startY);

  // Se movimento > 10px ‚Üí consideralo scroll
  if (diffX > 10 || diffY > 10) {
    isScrolling = true;
    clearTimeout(pressTimer);
  }
});

content.addEventListener("touchend", () => {
  clearTimeout(pressTimer);
});

    /* Buttons */
    const actions = document.createElement("div");
    actions.className = "message-actions";

/* üîó LINKand LOCATION */
if(div.classList.contains("link") || div.classList.contains("location")){
  const openBtn = document.createElement("button");
  openBtn.innerHTML = ICONS.link;
  openBtn.title = "Open link";

  openBtn.onclick = (e) => {
    e.stopPropagation();
    const url = m.text.match(/https?:\/\/[^\s]+/)?.[0];
    if (url) window.open(url, "_blank");
  };

  actions.appendChild(openBtn);
}

const pinBtn=document.createElement("button");
pinBtn.innerHTML = ICONS.pin;
pinBtn.title = m.pinned ? "Unpin" : "Pin";

if(m.pinned){
  pinBtn.classList.add("pin-active");
}

pinBtn.onclick = (e) => {
  e.stopPropagation();
  pinMessage(m.id,!m.pinned);
};

/* COPY */
const copy = document.createElement("button");
copy.innerHTML = ICONS.copy;
copy.title = "Copy text";
copy.onclick = async (e) => {
  e.stopPropagation();

  try {
    await navigator.clipboard.writeText(m.text || "");

    copy.style.background = "rgba(59,130,246,0.35)";
    copy.style.borderColor = "rgba(59,130,246,0.6)";

    setTimeout(() => {
      copy.style.background = "";
      copy.style.borderColor = "";
    }, 400);

  } catch (err) {
    console.error(err);
  }
};
actions.appendChild(copy);

    if(m.filename){
  const downloadBtn = document.createElement("button");
  downloadBtn.innerHTML = ICONS.download;
  downloadBtn.title = "Download file";
  downloadBtn.onclick = (e) => {
  e.stopPropagation();
  window.open(`${API}/files/${m.filename}?token=${API_TOKEN}`, "_blank");
};
  actions.appendChild(downloadBtn);
}

    const moveBtn=document.createElement("button");
    moveBtn.innerHTML = ICONS.move;
    moveBtn.title = "Move to another clipboard";
    moveBtn.onclick = (e) => {
  e.stopPropagation();
  moveMessage(m.id);
};

    const delBtn=document.createElement("button");
    delBtn.innerHTML = ICONS.delete;
    delBtn.title = "Delete message";
    delBtn.onclick = (e) => {
  e.stopPropagation();
  deleteMessage(m.id);
};

    actions.append(pinBtn, copy, moveBtn, delBtn);
    div.appendChild(actions);

    container.appendChild(div);
  });
}

/* =========================
   SEND MESSAGE
========================= */
async function send(){

  const textInput = document.getElementById("text");
  const fileInput = document.getElementById("file");
  const clipboardId = document.getElementById("clipboardSelect").value;

  const text = textInput.value.trim();
  const file = fileInput.files[0];

  if (!navigator.onLine) return;

  if (!file && !text) return;

  let response;

  try {

    if (file) {

      const form = new FormData();
      form.append("file", file);
      form.append("clipboard_id", clipboardId);
      form.append("text", text || "");

      response = await apiFetch(`${API}/messages/file`, {
        method: "POST",
        body: form
      });

    } else {

response = await apiFetch(`${API}/messages`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
    text: text,
    clipboard_id: parseInt(clipboardId)
  })
});
    }

    if (!response.ok) {
      console.error("Errore invio messaggio");
      return;
    }

    // Reset input solo se OK
    textInput.value = "";
    fileInput.value = "";
    document.getElementById("filePreview").style.display = "none";

    await load();

    const container = document.getElementById("messages");
    const order = document.getElementById("order").value;

    if (order === "recent") {
      container.scrollTo({ top: 0, behavior: "smooth" });
    }

    if (order === "oldest") {
      container.scrollTo({ top: container.scrollHeight, behavior: "smooth" });
    }

  } catch (err) {
    console.error("Errore di rete:", err);
  }
}

// ===============================
// FILE PREVIEW
// ===============================
document.getElementById("file").addEventListener("change", (e)=>{
  const preview = document.getElementById("filePreview");
  const file = e.target.files[0];

  if(file){
    preview.innerHTML = ICONS.copy + " " + file.name;
    preview.style.display = "block";
  } else {
    preview.style.display = "none";
  }
});

/* =========================
   PIN
========================= */
async function pinMessage(id,pinned){
  await apiFetch(`${API}/messages/${id}/pin?pinned=${pinned}`,{
    method:"POST"
  });
  load();
}

/* =========================
   MOVE
========================= */
async function moveMessage(id){

    // find message
    const messageCard = document.querySelector(`[data-id="${id}"]`);
    if (!messageCard) return;

    const imageWrapper = messageCard.querySelector(".image-wrapper"); 
    const img = imageWrapper?.querySelector("img");
if (img) {
  img.style.willChange = "transform";
  img.style.transform = "translateZ(0)";
  img.offsetHeight; // forza reflow
  img.style.transform = "";
  img.style.willChange = "";
}

    messageCard.classList.add("move-active");

    messageCard.classList.remove("show-actions");

    // avoid duoble menu
    if (messageCard.querySelector(".move-select")) return;

    const wrapper = document.createElement("div");
    wrapper.className = "move-select";

    const select = document.createElement("select");
    select.style.padding = "6px";
    select.style.borderRadius = "6px";

    CLIPBOARDS.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        select.appendChild(opt);
    });

    const btn = document.createElement("button");
btn.textContent = "Move";
btn.classList.add("confirm-move");

const cancelBtn = document.createElement("button");
cancelBtn.textContent = "Cancel";

cancelBtn.addEventListener("click", (e) => {

  e.stopPropagation();

  wrapper.remove();

  messageCard.classList.remove("move-active");

  const imageWrapper = messageCard.querySelector(".image-wrapper");
  if (imageWrapper) {
    imageWrapper.style.display = "";
    const img = imageWrapper.querySelector("img");
    if (img) img.style.display = "";
  }
});

wrapper.appendChild(select);
wrapper.appendChild(btn);
wrapper.appendChild(cancelBtn);

if (imageWrapper) {
  const img = imageWrapper.querySelector("img");
  if (img) img.style.display = "none";
  imageWrapper.style.display = "none";
}

messageCard.style.transform = "translateZ(0)";
messageCard.offsetHeight; // forza reflow
messageCard.style.transform = "";

messageCard.appendChild(wrapper);

    btn.onclick = async () => {

        await apiFetch(`${API}/messages/${id}/move?clipboard_id=${select.value}`, {
            method: "POST"
        });
 messageCard.classList.remove("move-active");
 load();
};
}

/*============================
       Edit Mode
===========================*/

async function enterEditMode(m, contentDiv){

const card = contentDiv.closest(".message");
if (card) {
  card.classList.remove("show-actions");
}

let originalText = m.text || "";

let urlPart = originalText;
let descriptionPart = originalText;

// if is card link, divide URL and description
if (card && (card.classList.contains("link") || card.classList.contains("location"))) {

  const urlMatch = originalText.match(/https?:\/\/[^\s]+/);
  urlPart = urlMatch ? urlMatch[0] : "";

  if (originalText.includes("---")) {
    const parts = originalText.split(/\n?---\n?/);
    descriptionPart = parts[1] ? parts[1].trim() : "";
  } else {
    descriptionPart = "";
  }
}

  const textarea = document.createElement("textarea");
  textarea.value = descriptionPart;
  textarea.style.width = "100%";
  textarea.style.minHeight = "80px";
  textarea.style.background = "#0f172a";
  textarea.style.color = "#e5e7eb";
  textarea.style.border = "1px solid #334155";
  textarea.style.borderRadius = "8px";
  textarea.style.padding = "8px";
  textarea.style.resize = "vertical";

  const actions = document.createElement("div");
  actions.style.marginTop = "8px";
  actions.style.display = "flex";
  actions.style.gap = "8px";

  const saveBtn = document.createElement("button");
  saveBtn.textContent = "Save";

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "Cancel";

  saveBtn.style.background = "#2563eb";
saveBtn.style.color = "white";
saveBtn.style.border = "none";
saveBtn.style.padding = "6px 12px";
saveBtn.style.borderRadius = "6px";

cancelBtn.style.background = "#334155";
cancelBtn.style.color = "white";
cancelBtn.style.border = "none";
cancelBtn.style.padding = "6px 12px";
cancelBtn.style.borderRadius = "6px";

  actions.appendChild(saveBtn);
  actions.appendChild(cancelBtn);

  contentDiv.innerHTML = "";
  contentDiv.style.display = "block"; 
  contentDiv.appendChild(textarea);
  contentDiv.appendChild(actions);

  textarea.focus();

  cancelBtn.onclick = () => load();

saveBtn.onclick = async () => {

  const form = new FormData();

  // If is link card
  const card = contentDiv.closest(".message");

  if (card && (card.classList.contains("link") || card.classList.contains("location"))) {

    const parts = m.text.split(/\n?---\n?/);
    const urlPart = parts[0].trim();

    const newDescription = textarea.value.trim();

    const currentDescription = parts[1] ? parts[1].trim() : "";

    if (newDescription) {
      form.append("text", urlPart + "\n---\n" + newDescription);
    } else {
      form.append("text", urlPart);
    }

  } else {
    form.append("text", textarea.value.trim());
  }

  await apiFetch(`/api/messages/${m.id}`, {
    method: "PUT",
    body: form
  });

  load();
};
}


/* =========================
   DELETE
========================= */
async function deleteMessage(id){
  await apiFetch(`${API}/messages/${id}`,{
    method:"DELETE"
  });
  load();
}

/* =========================
   INIT
========================= */
(async ()=>{
  await loadClipboards();
  load();
})();

// close image overlay
document.getElementById("imgOverlay").addEventListener("click", () => {
  document.getElementById("imgOverlay").style.display = "none";
});

document.getElementById("order").addEventListener("change", load);
document.getElementById("clipboardSelect").addEventListener("change", load);
document.getElementById("search").addEventListener("input", load);
document.getElementById("searchGlobal").addEventListener("change", load);

document.getElementById("filterPinned").addEventListener("change", load);
document.getElementById("filterFiles").addEventListener("change", load);
document.getElementById("filterText").addEventListener("change", load);

// blocca menu contestuale su immagini (iOS long press)
document.addEventListener("contextmenu", function(e){
  if (e.target.closest(".message.image")) {
    e.preventDefault();
  }
});

/* ==============================
   TOUCH CARD ACTIONS
============================== */

document.addEventListener("click", (e) => {

  const card = e.target.closest(".message");

  const isDesktop = window.matchMedia("(hover: hover) and (pointer: fine)").matches;

  // === DESKTOP ===
  if (isDesktop) {

    if (!card) {
      document.querySelectorAll(".message.show-actions")
        .forEach(el => el.classList.remove("show-actions"));
      return;
    }

    if (e.target.closest(".message-actions")) return;

    card.classList.toggle("show-actions");
    return;
  }

  // Click out ‚Üí closa everything
  if (!card) {
    document.querySelectorAll(".message.show-actions")
      .forEach(el => el.classList.remove("show-actions"));
    return;
  }

  // Click on buttons ‚Üí do nothing
  if (e.target.closest(".message-actions")) return;

  // Close all others
  document.querySelectorAll(".message.show-actions")
    .forEach(el => {
      if (el !== card) {
        el.classList.remove("show-actions");
      }
    });

  card.classList.toggle("show-actions");

});

document.getElementById("mobileMenuBtn")
  .addEventListener("click", (e) => {

    const menu = document.getElementById("mobileMenu");
    menu.classList.toggle("open");

    e.currentTarget.blur();
});

document.getElementById("refreshBtn")
  .addEventListener("click", async (e) => {

    const btn = e.currentTarget;

    btn.classList.add("spinning");

    await load();

    setTimeout(() => {
      btn.classList.remove("spinning");
    }, 600);
    btn.blur();
  });

// ==============================
// SYNC MOBILE CONTROLS
// ==============================

document.getElementById("order-mobile").addEventListener("change", (e) => {
  document.getElementById("order").value = e.target.value;
  load();
});

document.getElementById("filterPinnedMobile").addEventListener("change", (e)=>{
  document.getElementById("filterPinned").checked = e.target.checked;
  load();
});

document.getElementById("filterFilesMobile").addEventListener("change", (e)=>{
  document.getElementById("filterFiles").checked = e.target.checked;
  load();
});

document.getElementById("filterTextMobile").addEventListener("change", (e)=>{
  document.getElementById("filterText").checked = e.target.checked;
  load();
});

document.getElementById("closeMobileMenuBtn")
  .addEventListener("click", () => {
    document.getElementById("mobileMenu").classList.remove("open");
});

function updateOnlineStatus() {
  const banner = document.getElementById("offline-banner");
  const sendBtn = document.getElementById("sendBtn");

  if (!banner || !sendBtn) return;

  if (!navigator.onLine) {
    banner.style.display = "block";
    sendBtn.disabled = true;
  } else {
    banner.style.display = "none";
    sendBtn.disabled = false;
  }
}

window.addEventListener("online", updateOnlineStatus);
window.addEventListener("offline", updateOnlineStatus);

updateOnlineStatus();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("/service-worker.js")
    .then(() => console.log("Service Worker registrato"))
    .catch(err => console.error("SW error:", err));
}

</script>
</body>
</html>
